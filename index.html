<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Livechat</title>

	<!-- Bootstrap -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<!-- Bootstrap -->

	<!-- Fontawesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
	<!-- Fontawesome -->

	<!-- AOS -->
	<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
	<!-- AOS -->

	<style>
		* {
			font-family: Roboto, sans-serif;
		}

		*::-webkit-scrollbar {
			background-color: #fff;
			width: 16px;
		}

		/* background of the scrollbar except button or resizer */
		*::-webkit-scrollbar-track {
				background-color: #fff;
		}

		/* scrollbar itself */
		*::-webkit-scrollbar-thumb {
				background-color: #babac0;
				border-radius: 16px;
				border: 4px solid #fff;
		}

		/* set button(top and bottom of the scrollbar) */
		*::-webkit-scrollbar-button {
				display:none;
		}

		@keyframes wave{
			0%, 60%, 100% {
				transform: initial;
			}
			30% {
				transform: translateY(-3px);
			}
		}
		
		article.container {
			height: calc(100vh - 100px);
			width: 390px;
			/* background-color: red; */
			background-color: #fff;
			display: none;
			transition: transform 40s ease;

			position: absolute;
			z-index: 10;
			right: 2rem;
			bottom: 2rem;
			border-radius: 0 0 16px 16px;

			box-shadow: 0px 0px 400px -40px rgba(0,0,0,0.25);
			-webkit-box-shadow: 0px 0px 400px -40px rgba(0,0,0,0.25);
			-moz-box-shadow: 0px 0px 400px -40px rgba(0,0,0,0.25);
		}

		article.container.open {
			display: block;
			transform: translateY(200);
		}

		.header {
			height: 72px;
			background-color: #00a0c2;
			border-radius: 16px 16px 0 0;
			color: #fff;

			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
			font-size: 14px;
		}

		.header img {
			width: 40px;
			height: 40px;
			border-radius: 50px;
		}

		.header div > div {
			margin-left: 1rem;
		}

		.header p.header-name {
			font-weight: bold;
		}

		.body {
			height: calc(100vh - 242px);

			font-size: 14px;
			overflow-y: auto;
			padding: 1rem 0;
			/* padding-bottom: 1rem; */
		}

		.body img {
			width: 32px;
			height: 32px;
			border-radius: 32px;
			margin-left: 0.5rem;
		}

		.body div > div {
			margin-left: 0.3rem;
		}

		.body .body-bubble {
			background-color: #0eacc9;
			/* margin: 0 0 0.5rem 0.5rem; */
			/* border-radius: 16px; */
			padding: 0.5rem 1rem;
			max-width: 80%;
			color: #fff;
			letter-spacing: 0.15px;
			line-height: 1.5;
			font-size: 14px;
			min-width: 70px;
			margin: 5px 0px;
			margin-left: 4px;
			border-radius: 20px 20px 20px 20px;
		}

		.body .body-bubble.first {
			border-radius: 0px 20px 20px 20px;
		}

		.body .body-bubble span.dot {
			display: inline-block;
			width: 6px;
			height: 6px;
			border-radius: 50%;
			margin: 6px 2px 6px 2px;
			background-color: #fff;
			animation: wave 0.8s linear infinite;
		}

		.body .body-bubble span.dot:nth-child(2) {
			animation-delay: -0.6s;
		}

		.body .body-bubble span.dot:nth-child(3) {
			animation-delay: -0.4s;
		}

		.user > p {
			text-align: right;
			margin-right: 0.5rem;
		}

		.user i {
			color: #0883ff;
		}

		.client {
			margin-bottom: 8px;
		}

		.body .user-bubble {
			background-color: #e5e7f3;
			margin-right: 0.5rem;
			/* margin-bottom: 1rem; */
			border-radius: 20px 0px 20px 20px;
			padding: 0.5rem 1rem;
			letter-spacing: 0.15px;
			line-height: 1.5;
			font-size: 14px;
			max-width: 80%;
			margin: 5px 0px;
			margin-right: 4px;
		}
		
		.body .body-time {
			font-size: 11px;
			color: #384248;
			margin-top: 4px;
			color: #fff;
			text-align: right;
		}

		.body .user-time {
			font-size: 11px;
			color: #384248;
			text-align: right;
		}

		.body .options {
			padding: 0.5rem;
			/* text-align: right; */
		}

		.options > p{
			margin: 0.2rem;
		}

		.body .option {
			border-radius: 8px;
			padding: 0.5rem;
			/* margin-right: 1rem; */
			border: 1px solid #A7ACD0;
			background-color: #F5F5FA;
			color: #A7ACD0;
			/* margin-top: 0.5rem; */
			cursor: not-allowed;
			display: inline-block;
			width: fit-content;
		}

		.body .option.active {
			cursor: pointer;
			border: 1px solid #0eacc9;
			background-color: #e7fafe;
			color: #000;
		}

		.footer {
			height: 70px;
			border-top: 1px solid #e1e1e1;
			font-size: 14px;
			border-radius: 0 0 16px 16px;
		}

		.footer textarea {
			border: none;
			width: 100%;
  		resize: none; /* Remove the resize handle */
			height: 90%;
			border-radius: 0 0 16px 16px;
			padding: 0.5rem;
		}

		.footer button.btn-send {
			font-weight: bold;
			border: none;
			background-color: #14a2ba;
			color: #fff;
			font-size: 14px;
			max-height: 50px;
			width: 50px;
			border-radius: 15px;
			margin: 0.5rem;
		}

		.footer textarea:focus {
			outline: none; /* Removes the focus outline */
			border: none; /* Optional: Removes the border if it's set */
		}

		#inputan, #picture {
			display: none;
		}

		.toggle {
			position: absolute;
			padding: 2px;
			right: 2rem;
			bottom: 2rem;
			z-index: 2;
		}

		.toggle img {
			width: 90px;
			height: 90px;
			border-radius: 90px;
			cursor: pointer;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
		}
	</style>
</head>
<body>
	<!-- Begin::Container -->
	<article id="container" class="container p-0">
		<!-- Begin::Header -->
		<section class="header d-flex align-items-center justify-content-between px-3">
			<div class="d-flex">
				<img src="https://dev-stroom.air.id/file/asset/load/jpeg/q84uzdt33t" alt="icon">

				<div>
					<p class="header-name m-0">Livechat</p>
					<p class="header-info m-0">Ticket #0987462</p>
				</div>
			</div>

			<i class="fa-solid fa-xmark btn" style="color: #fff" onclick="toggleChat()"></i>
		</section>
		<!-- End::Header -->
		
		<!-- Begin::Body -->
		<section id="body" class="body">
			<!-- <div>
				<div class="body-bubble first">
					<p class="header-name m-0">Silahkan pilih topik populer berikut sesuai kendala atau pertanyaan Kakak</p>
					<p class="body-time mb-0">07:05</p>
				</div>
			</div>
			<div>
				<div class="body-bubble">
					<p class="header-name m-0">Silahkan pilih topik populer berikut sesuai kendala atau pertanyaan Kakak</p>
					<p class="body-time mb-0">07:05</p>
				</div>
			</div>
			<div>
				<div class="user">
					<div class="d-flex justify-content-end">
						<div class="user-bubble">
							<p class="m-0">Laporan Gangguan</p>
							<p class="user-time mb-0">07:10 
								<i class="fa-solid fa-check-double"></i>
							</p>	
						</div>
					</div>
				</div>
			</div> -->
		</section>
		<!-- End::Body -->

		<!-- Begin::Footer -->
		<section class="footer">
			<div id="inputan">
				<div class="d-flex">
					<textarea
						id="textinput"
						placeholder="Type message..."
						ref="textarea"
					></textarea>
	
					<button class="btn-send" onclick="sendChat()">
						<i class="fa-solid fa-paper-plane"></i>
					</button>
				</div>
			</div>

			<div id="picture" style="height: 100%;">
				<div class="d-flex align-items-center justify-content-center" style="height: 100%;">
					<button type="button" class="btn" onclick="triggerInputFile()">
						<i class="fa-solid fa-image"></i>
						Upload Gambar
					</button>
				</div>
			</div>
			
			<div id="default" style="height: 100%;">
				<div class="d-flex align-items-center justify-content-center" style="height: 100%;">
					<button type="button" class="btn" onclick="restart()">
						<i class="fa-solid fa-house"></i>
						Beranda
					</button>
				</div>
			</div>
		</section>
		<!-- End::Footer -->
	</article>
	<!-- End::Container -->

	<!-- Begin::File Input -->
	<input type="file" id="fileInput" style="display:none;" accept="image/*">
	<!-- End::File Input -->

	<!-- Begin::Toggle -->
	<div class="toggle">
		<img src="https://dev-stroom.air.id/file/asset/load/jpeg/q84uzdt33t" alt="toggle" onclick="toggleChat()">
	</div>
	<!-- End::Toggle -->

	<!-- Script -->
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>
	<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

	<script>
		AOS.init();

		axios.defaults.baseURL = 'https://socket-dev.iconpln.co.id/backend-indrawarman';

		window.addEventListener('load', function() {
			checkDevice();
			restart()
		})

		const checkDevice = () => {
			const idPengguna = localStorage.getItem('idPengguna')

			if (!idPengguna) {
				const payload = {
					identitas: navigator.userAgent,
					idTipe: '4',
					nama: ''
				}
				axios.post('ichat/user/identity/check', payload).then((resp) => {
					localStorage.setItem('idPengguna', resp.data.data.idPengguna)
				})
			}
		}

		const restart = () => {
			const options = document.getElementsByClassName("options");

			for (var i = 0; i < options.length; i++) {
				var children = options[i].children;

				for (var x = 0; x < children.length; x++) {
					children[x].removeAttribute('onclick');
					children[x].classList.remove('active');
				}
			}

			const payload = {
				idPengguna: localStorage.getItem('idPengguna') ?  localStorage.getItem('idPengguna') : '',
				idAplikasi: 1,
				idIsi: 0,
				idContactCenter: 2,
				idRoom: 2,
				via: 1,
				pesan: ''
			}
			axios.post('ichat/chat/bot/kirim', payload).then((resp) => {
				if (!resp.data.data) {
					throw new Error(resp.data.message)
				}

				handlePushElement(resp)
			})
		}

		const textarea = document.getElementById("textinput");

		textarea.addEventListener("keydown", function(event) {
			if (event.key === "Enter" && !event.shiftKey) {
				const idIsi = textarea.getAttribute('data-value')
				event.preventDefault(); // Prevent the default behavior of Enter key

				sendChat(idIsi)
			}
		});

		const fileInput = document.getElementById("fileInput");
		const triggerInputFile = () => { fileInput.click() }

		fileInput.addEventListener("change", function() {
			// Handle file selection here
			const fd = new FormData()
      fd.append('file', fileInput.files[0], fileInput.files[0].name)
			axios.post('https://rcrmdev.iconpln.co.id/icrm-be-cdn-dev/upload', fd, {
				headers: {
					Authorization: `
						Bearer eyJhbGciOiJIUzI1NiIsInppcCI6IkdaSVAifQ.H4sIAAAAAAAAAHWSTZOaMBjHv0omh15WJEFE5VRs7Qxlax11e_ISScAIJEwI03Z29rtvDMhqnZ4g_-f3vD-vsGmPMISvB8jphok8bwVZkrSQWcZTdoDhAXoHODpAVhFe2neheKM5EeOMq4qI5i85feapFHUpxqkcc2p5QSpi8aTHwVdGGfg2-FiKlAbTljubfwE0U21jvjVpuCrkmVhMs5LVUljuKfDmeDL3FjjwkG_NnO6WL9aIcS8km_6NkVXqk9TSSiet6yZ0XZWqanxXt8uN5ByZk1Lh1ErSNtVcCreUhLrnOncXeJYF2cQGbDTRbXMdWZesz71hus1Js2z7zjpdE4OSclA95HkOChw0B3gS-vN755fjZUIG8027_m2AwWIC-A7yHbwA2A_x7KasqNA8e8y9-8f4UcIt9SxzLjZM6esGrxieAIzDqXcLJ4ySsv1NVDOwUwchB3WJC0nZVpb9IaHgIc-eKVKcuHroaBr63ebOTPD7OV_ukwkKNkrmilQVU-Ph5IZkUbKPf0W7uB_rD65V5x2h6WLAP-R4vV9t19EzuDqC-MvP9VM31GNr70m0Zdk77o6tdfseJdF2H4FPYBmZCOshclL_387pklMzhL4ePDjdyPEerC4lbbbxbtWNjVfMbLCq-0re4AhyoqFZPZ5McYBmwQiyP_VVWASz4O0dFuFfwuEDAAA.tTl9eYa8PJW6Nj_Fylu7h1BDVixnCEmb235QyQ_nuXc
					`
				}
			}).then((resp) => {
				console.log('resp upload => ', resp.data)
			})
		});

		const sendChat = (idIsi) => {
			const payload = {
				idPengguna: localStorage.getItem('idPengguna') ?  localStorage.getItem('idPengguna') : '',
				idAplikasi: 1,
				idIsi: idIsi,
				idContactCenter: 2,
				idRoom: 2,
				via: 1,
				pesan: textarea.value
			}

			axios.post('ichat/chat/bot/kirim', payload).then((resp) => {
				if (!resp.data.data) {
					throw new Error(resp.data.message)
				}

				textarea.value = ''

				handlePushElement(resp)
			})
		}

		const toggleChat = () => {
			const container = document.getElementById('container')
			container.classList.toggle('open');
		}

		const handleSelectOption = (idIsi) => {
			const id = `option${idIsi}`
			const selectedOption = document.getElementById(id)
			const body = document.getElementById('body')
			const value = selectedOption.getAttribute('data-value')
			const valueSplit = value.split(' ')

			const parentOption = selectedOption.parentElement

			var children = parentOption.children;

			for (var i = 0; i < children.length; i++) {
				children[i].removeAttribute('onclick');
				children[i].classList.remove('active');
			}

			const payload = {
				idPengguna: localStorage.getItem('idPengguna') ?  localStorage.getItem('idPengguna') : '',
				idAplikasi: 1,
				idIsi: valueSplit[2],
				idContactCenter: 2,
				idRoom: 2,
				via: 1,
				pesan: ''
			}

			body.innerHTML += `
				<div>
					<div class="user">
						<div class="d-flex justify-content-end">
							<div class="user-bubble">
								<p class="m-0">${selectedOption.innerText}</p>
								<p class="user-time mb-0">
									${timeCondition(`${valueSplit[0]} ${valueSplit[1]}`)}
									<i class="fa-solid fa-check-double"></i>
								</p>	
							</div>
						</div>
					</div>
				</div>
			`

			body.innerHTML += `
				<div id="loading" class="d-flex align-items-end p-0">
					<div>
						<div class="body-bubble first">
							<span class="dot"></span>
							<span class="dot"></span>
							<span class="dot"></span>
						</div>
					</div>
				</div>
			`

			axios.post('ichat/chat/bot/kirim', payload).then((resp) => {
				if (!resp.data.data) {
					throw new Error(resp.data.message)
				}
				document.getElementById('loading').remove()
				handlePushElement(resp)
			})
		}

		const handlePushElement = (resp) => {
			const body = document.getElementById('body')
			const data = resp.data
			const idPengguna = localStorage.getItem('idPengguna')

			data.data.forEach((item, index) => {
				if (item.kodeInput == '1') {
					document.getElementById('inputan').style.display = 'block'
					document.getElementById('picture').style.display = 'none'
					document.getElementById('default').style.display = 'none'
					const textarea = document.getElementById("textinput")
					textarea.setAttribute('data-value', item.idIsi)
				} else if (item.kodeInput == '2') {
					document.getElementById('inputan').style.display = 'none'
					document.getElementById('picture').style.display = 'block'
					document.getElementById('default').style.display = 'none'
				} else if (item.idIsi != '0' && item.idPengguna != idPengguna) {
					document.getElementById('inputan').style.display = 'none'
					document.getElementById('picture').style.display = 'none'
					document.getElementById('default').style.display = 'block'
					body.innerHTML += `
						<div id="body-${index}" class="d-flex align-items-end p-0">
							<div>
								<div class="body-bubble first">
									<p class="header-name m-0">${item.isi}</p>
									<p class="body-time mb-0">${timeCondition(item.waktuPesan)}</p>
								</div>
							</div>
						</div>
					`
				} else if (item.isi.includes('</')) {
					const pesanArray = item.isi.split("</pesan>")
						.filter(item => item.trim() !== "")
						.map(item => {
								const idIsi = item.match(/<idIsi>(.*?)<\/idIsi>/)[1];
								const isi = item.match(/<isi>(.*?)<\/isi>/)[1];
								return { idIsi: parseInt(idIsi), isi };
						});

					let optionTemp = ''
					pesanArray.forEach((pesan, iPesan) => {
						optionTemp += `
							<p
								id="option${pesan.idIsi}"
								class="option active"
								data-value='${item.waktuPesan} ${pesan.idIsi}'
								onclick='handleSelectOption(${pesan.idIsi})'>
								${pesan.isi}
							</p>
						`
						if (iPesan === pesanArray.length - 1) {
							body.innerHTML += `
								<div class="options">
									${optionTemp}
								</div>
							`
						}
					})
				} else if (item.idIsi == '0' && item.idPengguna != idPengguna) {
					body.innerHTML += `
						<div id="body-${index}" class="d-flex align-items-end p-0">
							<div>
								<div class="body-bubble first">
									<p class="header-name m-0">${item.isi.replaceAll('**', '<br>')}</p>
									<p class="body-time mb-0">${timeCondition(item.waktuPesan)}</p>
								</div>
							</div>
						</div>
					`
				} else {
					body.innerHTML += `
						<div>
							<div class="user">
								<div class="d-flex justify-content-end">
									<div class="user-bubble">
										<p class="m-0">${item.isi}</p>
										<p class="user-time mb-0">
											${timeCondition(item.waktuPesan)}
											<i class="fa-solid fa-check-double"></i>
										</p>	
									</div>
								</div>
							</div>
						</div>
					`
				}
			});
			body.scroll({ top: body.scrollHeight, behavior: 'smooth' });
		}

		const dateCondition = (time) => {

		}
		
		const timeCondition = (time) => {
			const date = new Date(time);
			const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
			const formattedTime = date.toLocaleString('en-US', {
				hour: 'numeric',
				minute: 'numeric',
				timeZone: userTimeZone,
				hour12: false,
			});

			return formattedTime
		}
	</script>
	<!-- Script -->
</body>
</html>